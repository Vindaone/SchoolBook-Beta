<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Post - SchoolBook</title>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body{font-family:'Lato',sans-serif;background:#000;color:#fff;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
  .container{max-width:600px;width:100%;background:#111;border-radius:12px;padding:20px;margin-top:20px;box-shadow:0 0 15px rgba(255,255,255,0.05);position:relative}
  button{background:#fff;color:#000;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;margin:8px 0}
  button:hover{background:#ccc}
  .delete-btn{position:absolute;bottom:10px;right:10px;background:none;color:#f44;font-size:0.9em;cursor:pointer;display:flex;align-items:center;gap:6px;opacity:0.8}
  .delete-btn:hover{opacity:1;transform:scale(1.02)}
  .reactions-bar{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
  .reaction{display:flex;align-items:center;gap:6px;font-size:1em;cursor:pointer;user-select:none}
  .reaction .count{margin-left:4px;font-weight:700}
  .timestamp{font-size:0.6em;opacity:0.6;margin-top:4px}
  .upload-card{background:#111;border-radius:10px;padding:15px;margin-top:20px;box-shadow:0 0 10px rgba(255,255,255,0.05);text-align:center}
  .upload-card img{width:100%;border-radius:8px;margin-top:10px}
  .upload-card h3{margin:10px 0 6px}
  .upload-card p{font-size:0.95em;opacity:0.9}
  .add-upload-wrapper{margin-top:16px;display:flex;justify-content:center}
  .add-upload-btn{background:#fff;color:#000;border-radius:8px;padding:8px 12px;cursor:pointer}
  .status{margin-top:8px;font-size:0.9em;opacity:0.85}
</style>
</head>
<body>
  <button onclick="location.href='index.html'">‚Üê Back</button>

  <div class="container" id="postContainer">
    <h2 id="title">Loading...</h2>
    <p><strong>by <span id="user">...</span></strong></p>
    <p class="timestamp" id="timestamp"></p>
    <p id="text" style="white-space:pre-wrap"></p>

    <div class="reactions-bar" id="reactionsBar">
      <div class="reaction" data-type="like">üëç <span class="count">0</span></div>
      <div class="reaction" data-type="love">‚ù§Ô∏è <span class="count">0</span></div>
      <div class="reaction" data-type="haha">üòÇ <span class="count">0</span></div>
      <div class="reaction" data-type="wow">üòÆ <span class="count">0</span></div>
      <div class="reaction" data-type="sad">üò¢ <span class="count">0</span></div>
      <div class="reaction" data-type="angry">üò° <span class="count">0</span></div>
    </div>

    <!-- Delete post: removes entire node posts/{postId} -->
    <button class="delete-btn" id="deletePostBtn" title="Delete Post">
      <i data-lucide="trash-2"></i> Delete Post
    </button>
  </div>

  <!-- Add Upload (placed under the post, not floating) -->
  <div class="add-upload-wrapper" id="addUploadWrapper">
    <button id="addUploadBtn" class="add-upload-btn">Upload Image</button>
  </div>

  <!-- Upload card area -->
  <div id="uploadContainer" class="upload-card" style="display:none"></div>

  <div class="status" id="status"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, remove, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoQdbT4FVaPcbgKmmgBg2Ea5NAYJj66Hk",
  authDomain: "void-c8188.firebaseapp.com",
  databaseURL: "https://void-c8188-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "void-c8188",
  storageBucket: "void-c8188.firebasestorage.app",
  messagingSenderId: "16905892121",
  appId: "1:16905892121:web:99901fc948016d7efb9588",
  measurementId: "G-QNMMR5Z6JL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(window.location.search);
const postId = params.get('id');

const titleEl = document.getElementById('title');
const userEl = document.getElementById('user');
const textEl = document.getElementById('text');
const timestampEl = document.getElementById('timestamp');
const reactionsBar = document.getElementById('reactionsBar');
const uploadContainer = document.getElementById('uploadContainer');
const addUploadBtn = document.getElementById('addUploadBtn');
const addUploadWrapper = document.getElementById('addUploadWrapper');
const deletePostBtn = document.getElementById('deletePostBtn');
const statusEl = document.getElementById('status');

const reactionTypes = ["like","love","haha","wow","sad","angry"];

function formatTime(ms){
  const d = new Date(ms);
  const options = { month:'short', day:'numeric' };
  const datePart = d.toLocaleDateString('en-US', options);
  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2,'0');
  const ampm = hours>=12?'PM':'AM';
  hours = hours%12; hours = hours?hours:12;
  return `${datePart} - ${hours}:${minutes} ${ampm}`;
}

// ensure we have a postId
if(!postId){
  titleEl.textContent = "No post specified.";
  addUploadWrapper.style.display = 'none';
  statusEl.textContent = 'Missing post id in URL.';
} else {
  // Listen live to the post node so UI updates automatically when anything changes
  const postRef = ref(db, 'posts/' + postId);
  onValue(postRef, (snap) => {
    if(!snap.exists()){
      titleEl.textContent = "Post not found.";
      uploadContainer.style.display = 'none';
      addUploadWrapper.style.display = 'none';
      statusEl.textContent = 'This post was deleted.';
      return;
    }
    const post = snap.val();
    titleEl.textContent = post.title || '';
    userEl.textContent = post.user || '';
    textEl.textContent = post.text || '';
    timestampEl.textContent = post.timestamp ? formatTime(post.timestamp) : '';
    // reactions display
    const reactions = post.reactions || {};
    reactionTypes.forEach(type=>{
      const el = reactionsBar.querySelector(`.reaction[data-type="${type}"] .count`);
      if(el) el.textContent = reactions[type] || 0;
    });

    // upload presence: if `upload` exists under this post, show it; otherwise show add button
    if(post.upload){
      const up = post.upload;
      uploadContainer.style.display = 'block';
      uploadContainer.innerHTML = `
        <h3>${escapeHtml(up.title || '')}</h3>
        <p>${escapeHtml(up.description || '')}</p>
        ${up.image ? `<img src="${escapeAttr(up.image)}" alt="upload image">` : ''}
        <div style="margin-top:10px">
          <button id="deleteUploadBtn" style="background:#f44;color:#fff">Delete Upload</button>
        </div>
      `;
      addUploadWrapper.style.display = 'none';

      // attach delete upload handler
      const deleteUploadBtn = document.getElementById('deleteUploadBtn');
      deleteUploadBtn.onclick = async () => {
        try{
          statusEl.textContent = 'Deleting upload...';
          await remove(ref(db, 'posts/' + postId + '/upload'));
          statusEl.textContent = 'Upload deleted.';
        }catch(e){
          console.error(e);
          statusEl.textContent = 'Failed to delete upload.';
        }
      };

    } else {
      uploadContainer.style.display = 'none';
      addUploadWrapper.style.display = 'flex';
    }
  }, (err) => {
    console.error('onValue error', err);
    statusEl.textContent = 'Failed to load post.';
  });
}

// reactions handlers (use runTransaction to safely increment)
reactionTypes.forEach(type=>{
  const btn = reactionsBar.querySelector(`.reaction[data-type="${type}"]`);
  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    if(!postId) return;
    const refPath = 'posts/' + postId + '/reactions/' + type;
    try{
      await runTransaction(ref(db, refPath), (current) => {
        return (current || 0) + 1;
      });
      // UI will update automatically through onValue listener
    }catch(err){
      console.error('reaction tx failed', err);
      statusEl.textContent = 'Failed to add reaction.';
    }
  });
});

// add upload button takes user to upload.html?id=postId
addUploadBtn.addEventListener('click', () => {
  if(!postId) return;
  location.href = `upload.html?id=${postId}`;
});

// delete post button removes whole post node (and its upload)
deletePostBtn.addEventListener('click', async () => {
  if(!postId) return;
  if(!confirm('Delete this post? This will remove any upload too.')) return;
  try{
    statusEl.textContent = 'Deleting post...';
    await remove(ref(db, 'posts/' + postId));
    statusEl.textContent = 'Post deleted.';
    setTimeout(()=>location.href = 'index.html', 800);
  }catch(e){
    console.error(e);
    statusEl.textContent = 'Failed to delete post.';
  }
});

// small helpers to avoid XSS when injecting strings
function escapeHtml(s){
  if(!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}
function escapeAttr(s){
  if(!s) return '';
  return s.replaceAll('"','&quot;').replaceAll("'", '&#39;');
}

lucide.createIcons();
</script>
</body>
</html>
