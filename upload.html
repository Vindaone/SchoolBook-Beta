<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upload Image - SchoolBook</title>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Lato',sans-serif;background:#000;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px}
  input,textarea{width:90%;margin:10px 0;padding:10px;border:none;border-radius:6px;background:#111;color:#fff}
  button{padding:10px 18px;background:#fff;color:#000;border:none;border-radius:6px;cursor:pointer}
  button:hover{background:#ccc}
  #status{margin-top:12px;font-size:0.95em;opacity:0.9}
  img#preview{max-width:90%;border-radius:8px;margin-top:10px;display:none}
</style>
</head>
<body>
  <button onclick="location.href='index.html'">‚Üê Back</button>
  <h2>Upload Image</h2>
  <input id="title" type="text" placeholder="Title (for the upload)">
  <textarea id="description" rows="3" placeholder="Description"></textarea>
  <input id="imageInput" type="file" accept="image/*">
  <img id="preview" alt="preview">
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="uploadBtn">Upload</button>
    <button id="cancelBtn" style="background:#333;color:#fff">Cancel</button>
  </div>
  <div id="status"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoQdbT4FVaPcbgKmmgBg2Ea5NAYJj66Hk",
  authDomain: "void-c8188.firebaseapp.com",
  databaseURL: "https://void-c8188-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "void-c8188",
  storageBucket: "void-c8188.firebasestorage.app",
  messagingSenderId: "16905892121",
  appId: "1:16905892121:web:99901fc948016d7efb9588",
  measurementId: "G-QNMMR5Z6JL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const CLOUD_NAME = "dlx6ymgiq";     // <- your cloud name
const UPLOAD_PRESET = "free32";     // <- unsigned preset (must be unsigned in Cloudinary dashboard)
const params = new URLSearchParams(window.location.search);
const postId = params.get('id');

const titleInput = document.getElementById('title');
const descInput = document.getElementById('description');
const imageInput = document.getElementById('imageInput');
const preview = document.getElementById('preview');
const uploadBtn = document.getElementById('uploadBtn');
const cancelBtn = document.getElementById('cancelBtn');
const statusEl = document.getElementById('status');

if(!postId){
  statusEl.textContent = 'Missing post id in URL. Go back and try again.';
  uploadBtn.disabled = true;
}

// preview selected image
imageInput.addEventListener('change', () => {
  const f = imageInput.files[0];
  if(!f) { preview.style.display='none'; return; }
  const reader = new FileReader();
  reader.onload = e => {
    preview.src = e.target.result;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(f);
});

// cancel -> go back to post
cancelBtn.addEventListener('click', () => {
  if(postId) location.href = `post.html?id=${postId}`; else location.href='index.html';
});

uploadBtn.addEventListener('click', async () => {
  const title = titleInput.value.trim();
  const description = descInput.value.trim();
  const file = imageInput.files[0];

  if(!title || !description || !file){
    statusEl.textContent = 'Please provide title, description, and an image.';
    return;
  }
  statusEl.textContent = 'Uploading The Image Bro....';
  uploadBtn.disabled = true;

  try{
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: 'POST',
      body: fd
    });

    const data = await res.json();
    if(!data || !data.secure_url){
      console.error('Cloudinary response', data);
      statusEl.textContent = 'Cloudinary upload failed. Check cloud name & preset.';
      uploadBtn.disabled = false;
      return;
    }

    // Save upload under posts/{postId}/upload
    const uploadRef = ref(db, `posts/${postId}/upload`);
    await set(uploadRef, {
      title,
      description,
      image: data.secure_url,
      timestamp: Date.now()
    });

    statusEl.textContent = 'Image Uploaded';
    setTimeout(()=>location.href = `post.html?id=${postId}`, 900);

  }catch(err){
    console.error(err);
    statusEl.textContent = 'Upload error. Check console for details.';
    uploadBtn.disabled = false;
  }
});
</script>
</body>
</html>